import json

import pinecone
import streamlit as st

from pages.lib.openai_call import get_embedding, get_chat_openai
from pages.lib.prompts import GENERATE_SELF_INTRODUCTION_PROMPT, GUIDELINE_PROMPT

st.set_page_config(
    page_title="Hello",
    page_icon="ğŸ‘‹",
)

ground_guideline = {
    "ì§€ì› ë™ê¸°": [
        "ì§€ì›í•˜ëŠ” íšŒì‚¬ì— ëŒ€í•œ ì´í•´ì™€ ê·¸ íšŒì‚¬ì—ì„œ ì¼í•˜ê³  ì‹¶ì€ ì´ìœ ë¥¼ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "ì§€ì›í•˜ëŠ” ì§ë¬´ì— ëŒ€í•œ ì´í•´ì™€ ê·¸ ì§ë¬´ë¥¼ ìˆ˜í–‰í•˜ê³  ì‹¶ì€ ì´ìœ ë¥¼ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "ì§€ì›í•˜ëŠ” íšŒì‚¬ì™€ ìœ¼ë¡œ ì§€ì› ë™ê¸°ë¥¼ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "ì§€ì›í•˜ëŠ” ì§ë¬´ë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ë‹¹ì‹ ì˜ ëŠ¥ë ¥ê³¼ ê²½í—˜ì„ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
    ],
    "ì§ë¬´ ê´€ì‹¬ ê³„ê¸°": [
        "ì–´ë–¤ ê²½í—˜ ë˜ëŠ” ì‚¬ê±´ì´ ì§ë¬´ì— ê´€ì‹¬ì„ ê°–ê²Œ í–ˆëŠ”ì§€ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”.",
        "ì´ ì§ë¬´ì— ëŒ€í•´ ë” ì•Œì•„ê°€ê³  ì‹¶ì—ˆë˜ ì´ìœ ë¥¼ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "ê´€ë ¨ ê²½í—˜(í•™ìŠµ, í”„ë¡œì íŠ¸, ì¸í„´, ì•„ë¥´ë°”ì´íŠ¸ ë“±)ì„ ì–´ë–»ê²Œ ì§„í–‰í–ˆëŠ”ì§€ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "ì§ë¬´ì— ëŒ€í•œ ì´í•´ì™€ ê´€ì‹¬ì´ ì–´ë–»ê²Œ ì„±ì¥í–ˆëŠ”ì§€ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "ì´ ì§ë¬´ë¥¼ í†µí•´ ì´ë£¨ê³  ì‹¶ì€ ì¥ê¸°ì  ëª©í‘œê°€ ìˆë‹¤ë©´ í•¨ê»˜ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
    ],
    "íšŒì‚¬ ê²½ë ¥": [
        "ì´ì „ ì§ì¥ì—ì„œì˜ ì£¼ìš” ì—…ë¬´ì™€ ì±…ì„ì„ ìƒì„¸í•˜ê²Œ ì‘ì„±í•´ ì£¼ì„¸ìš”.",
        "ê²½ë ¥ ê¸°ê°„ ë™ì•ˆ ì´ë£¬ ì„±ê³¼ì™€ ê²°ê³¼ë¥¼ êµ¬ì²´ì ì¸ ì˜ˆì‹œì™€ í•¨ê»˜ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "ì§ì¥ì—ì„œ ê²ªì—ˆë˜ ì–´ë ¤ì›€ê³¼ ì´ë¥¼ ê·¹ë³µí•œ ê³¼ì •ì„ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "í•´ë‹¹ ê²½ë ¥ì´ ì§€ì›í•˜ëŠ” ì§ë¬´ì— ì–´ë–»ê²Œ ë„ì›€ì´ ë  ìˆ˜ ìˆëŠ”ì§€ ì—°ê²°í•˜ì—¬ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "ì§ì¥ì—ì„œì˜ í•™ìŠµ ê²½í—˜ê³¼ ê°œì¸ì  ì„±ì¥ì„ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
    ],
    "í”„ë¡œì íŠ¸ ê²½í—˜": [
        "í”„ë¡œì íŠ¸ì˜ ëª©ì ê³¼ ë‹¹ì‹ ì˜ ì—­í• ì„ ëª…í™•í•˜ê²Œ ì‘ì„±í•´ ì£¼ì„¸ìš”.",
        "í”„ë¡œì íŠ¸ë¥¼ ìˆ˜í–‰í•˜ë©° ì‚¬ìš©í•œ ê¸°ìˆ , ë„êµ¬, ë°©ë²•ë¡ ì— ëŒ€í•´ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "í”„ë¡œì íŠ¸ ê³¼ì •ì—ì„œ ë°œìƒí•œ ì£¼ìš” ë„ì „ê³¼ ì´ë¥¼ ì–´ë–»ê²Œ ê·¹ë³µí–ˆëŠ”ì§€ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "í”„ë¡œì íŠ¸ ê²°ê³¼ì™€ ì´ë¥¼ í†µí•´ ì–»ì€ êµí›ˆ ë˜ëŠ” ì„±ê³¼ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”.",
        "ì´ í”„ë¡œì íŠ¸ ê²½í—˜ì´ ì–´ë–»ê²Œ ë‹¹ì‹ ì˜ ì „ë¬¸ì„±ì„ ê°•í™”í–ˆëŠ”ì§€ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
    ],
    "ì„±ê²©ì˜ ì¥ë‹¨ì ": [
        "ìì‹ ì˜ ì„±ê²©ì—ì„œ ê°€ì¥ ê°•ì ì´ë¼ê³  ìƒê°í•˜ëŠ” ë¶€ë¶„ì„ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "ì´ëŸ¬í•œ ê°•ì ì´ ì—…ë¬´ë‚˜ ì¼ìƒìƒí™œì—ì„œ ì–´ë–»ê²Œ ê¸ì •ì ì¸ ì˜í–¥ì„ ë¼ì³¤ëŠ”ì§€ ì˜ˆì‹œì™€ í•¨ê»˜ ì‘ì„±í•´ ì£¼ì„¸ìš”.",
        "ì„±ê²©ì˜ ë‹¨ì ì´ë‚˜ ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ì„ ì†”ì§í•˜ê²Œ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "ì´ ë‹¨ì ì„ ê·¹ë³µí•˜ê¸° ìœ„í•´ ì–´ë–¤ ë…¸ë ¥ì„ í•˜ê³  ìˆëŠ”ì§€ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”.",
        "ì„±ê²©ì˜ ì¥ë‹¨ì ì´ í•´ë‹¹ ì§ë¬´ì™€ ì–´ë–»ê²Œ ì—°ê´€ë˜ëŠ”ì§€ ë¶„ì„í•˜ì—¬ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
    ],
    "ì–´ë ¤ì›€ ê·¹ë³µ ê³¼ì •": [
        "ì–´ë ¤ì›€ì„ ê²½í—˜í•œ êµ¬ì²´ì ì¸ ìƒí™©ì„ ì„¤ëª…í•´ ì£¼ì„¸ìš”.",
        "ì´ ì–´ë ¤ì›€ì´ ë‹¹ì‹ ì—ê²Œ ì–´ë–¤ ì˜í–¥ì„ ë¼ì³¤ëŠ”ì§€ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "ì–´ë ¤ì›€ì„ ê·¹ë³µí•˜ê¸° ìœ„í•´ êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ë…¸ë ¥ì„ í–ˆëŠ”ì§€ ì‘ì„±í•´ ì£¼ì„¸ìš”.",
        "ê·¹ë³µ ê³¼ì •ì—ì„œ ì–»ì€ êµí›ˆì´ë‚˜ ê°œì¸ì ì¸ ì„±ì¥ì— ëŒ€í•´ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "ì´ëŸ¬í•œ ê²½í—˜ì´ ì•ìœ¼ë¡œ ì–´ë–»ê²Œ ë‹¹ì‹ ì„ ë„ìš¸ ê²ƒì¸ì§€ ì—°ê²°í•˜ì—¬ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
    ],
    "ë¬¸ì œ í•´ê²° ê²½í—˜": [
        "ë¬¸ì œê°€ ë°œìƒí•œ ìƒí™©ê³¼ ê·¸ ë¬¸ì œì˜ ë³¸ì§ˆì„ ëª…í™•í•˜ê²Œ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ êµ¬ìƒí•œ ë‹¤ì–‘í•œ í•´ê²°ì±…ê³¼ ì ‘ê·¼ ë°©ë²•ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”.",
        "ìµœì¢…ì ìœ¼ë¡œ ì„ íƒí•œ í•´ê²°ì±…ê³¼ ê·¸ ì´ìœ ë¥¼ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "ë¬¸ì œ í•´ê²° ê³¼ì •ì—ì„œ ì–´ë–¤ ë„ì „ê³¼ ì–´ë ¤ì›€ì´ ìˆì—ˆëŠ”ì§€ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
        "ë¬¸ì œ í•´ê²° ê²°ê³¼ì™€ ì´ë¥¼ í†µí•´ ë°°ìš´ êµí›ˆì„ ì„œìˆ í•´ ì£¼ì„¸ìš”.",
    ],
}
favor_info = ""

# ìŠ¤íŠ¸ë¦¼ë¦¿ì˜ ì„¸ì…˜ ìƒíƒœë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒíƒœ ìœ ì§€
if "guideline_list" not in st.session_state:
    st.session_state["guideline_list"] = []
if "user_answer" not in st.session_state:
    st.session_state["user_answer"] = {}

question = st.radio(
    "ë‹µë³€í•˜ê³ ì í•˜ëŠ” ì§ˆë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.",
    ("ì§€ì› ë™ê¸°", "ì§ë¬´ ê´€ì‹¬ ê³„ê¸°", "íšŒì‚¬ ê²½ë ¥", "í”„ë¡œì íŠ¸ ê²½í—˜", "ì„±ê²©ì˜ ì¥ë‹¨ì ", "ì–´ë ¤ì›€ ê·¹ë³µ ê³¼ì •", "ë¬¸ì œ í•´ê²° ê²½í—˜", "ê¸°íƒ€"),
)

if question == "ê¸°íƒ€":
    question = st.text_input("ì§ˆë¬¸ ë‚´ìš©ì„ ì§ì ‘ ì‘ì„±í•´ì£¼ì„¸ìš”.")

if st.button("ê°€ì´ë“œë¼ì¸ ìƒì„±í•˜ê¸°!"):
    with st.spinner("ê°€ì´ë“œë¼ì¸ì„ ìƒì„±ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."):
        try:
            # ê¸°ì¡´ì— ground_guidelineì„ ì‚¬ìš©í•˜ê³  ìˆë‹¤ë©´, ì´ë¥¼ st.session_stateë¡œ ëŒ€ì²´
            st.session_state["guideline_list"] = ground_guideline[question]
        except KeyError:
            prompt = GUIDELINE_PROMPT.format(question=question)

            # í”„ë¡¬í”„íŠ¸ë¡œ ìƒì„±í•œ ê°€ì´ë“œë¼ì¸
            guideline_string = get_chat_openai(prompt)

            # ìƒì„±ëœ string í˜•íƒœì˜ ê°€ì´ë“œë¼ì¸ì„ listë¡œ ë³€í™˜
            st.session_state["guideline_list"] = json.loads(
                guideline_string.replace("'", '"')
            )


# ê° ê°€ì´ë“œë¼ì¸ë³„ë¡œ text ì…ë ¥ í•„ë“œ ìƒì„±
for idx, guideline in enumerate(st.session_state["guideline_list"]):
    st.session_state["user_answer"][guideline] = st.text_area(
        label=guideline,
        placeholder=f"{guideline}ì— ëŒ€í•œ ìì‹ ì˜ ê²½í—˜ì„ ê°„ë‹¨í•˜ê²Œ ì†Œê°œí•´ì£¼ì„¸ìš”.",
        height=200,
        key=f"guideline_{idx}",  # ê° text_areaì— ê³ ìœ í•œ key ì œê³µ
    )

# ê¸°ì—… ìš°ëŒ€ì‚¬í•­
favor_info = st.text_area(label="ê¸°ì—… ê³µê³ ì˜ ìš°ëŒ€ì‚¬í•­ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”.", placeholder="ìš°ëŒ€ì‚¬í•­", height=200)


if st.button("ìê¸°ì†Œê°œì„œ ìƒì„±í•˜ê¸°!"):
    with st.spinner("ë‹µë³€ì„ ìƒì„±ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."):
        # ë‹µë³€ ì·¨í•©
        saved_self_introduction = ""

        for guideline in st.session_state["guideline_list"]:
            saved_self_introduction += (
                f'# {guideline} \n {st.session_state["user_answer"][guideline]} \n\n'
            )
        print(saved_self_introduction)

        # vectorDBì—ì„œ ìœ ì‚¬í•œ ë°ì´í„° ê²€ìƒ‰
        pinecone.init(api_key=st.secrets["PINECONE_API_KEY"], environment="gcp-starter")
        index = pinecone.Index("resumai-self-introduction-index")

        query_embedding = get_embedding(saved_self_introduction)  # ìœ ì €ê°€ ì§ˆë¬¸ì— ë‹µë³€í•œ ê²ƒì„ ì„ë² ë”©
        retrieved_data = index.query(
            vector=query_embedding, top_k=3, include_metadata=True
        )  # ìœ ì‚¬í•œ top 3ê°œì˜ ë‹µë³€

        data = retrieved_data["matches"]

        data_1_question = data[0]["metadata"]["question"]
        data_1_answer = data[0]["metadata"]["answer"]

        data_2_question = data[1]["metadata"]["question"]
        data_2_answer = data[1]["metadata"]["answer"]

        data_3_question = data[2]["metadata"]["question"]
        data_3_answer = data[2]["metadata"]["answer"]

        # í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ
        examples = (
            f"ì˜ˆì‹œ1) \n Question: {data_1_question}, \n Answer: {data_1_answer}, \n\n "
            f"ì˜ˆì‹œ2) \n Question: {data_2_question}, \n Answer: {data_2_answer}, \n\n "
            f"ì˜ˆì‹œ3) \nQuestion: {data_3_question}, \n Answer: {data_3_answer}"
        )

        prompt = GENERATE_SELF_INTRODUCTION_PROMPT.format(
            favor_info=favor_info,
            question=question,
            context=saved_self_introduction,
            examples=examples,
        )

        answer = get_chat_openai(prompt)

        if answer:
            st.success("ë‹µë³€ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!")
            st.write(answer)
        else:
            st.error("ë‹µë³€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤..")

        print(answer)
